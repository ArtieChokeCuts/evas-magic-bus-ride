<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Super Eva's Magic Bus Ride: Tap Shooter</title>
    <style>
        /* --- CORE STYLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; }
        body { 
            overflow: hidden; 
            background: #fdf2f8; /* Soft Pink Base */
            font-family: "Comic Sans MS", "Trebuchet MS", sans-serif; 
            touch-action: none; 
        }

        /* Neon HUD Dashboard */
        #hud-overlay {
            position: absolute; inset: 0; z-index: 100; pointer-events: none;
            display: flex; justify-content: space-between; padding: 20px;
        }

        .neon-panel {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid; box-shadow: 0 0 15px currentColor;
            padding: 15px 18px; border-radius: 12px;
            min-width: 120px; text-align: center; font-weight: 800;
        }

        #math-panel { border-color: #00f3ff; color: #00f3ff; } /* Blue Neon */
        #word-panel { border-color: #ff00ff; color: #ff00ff; } /* Pink Neon */

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute; inset: 0; pointer-events: none; z-index: 100;
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px;
        }

        /* Frosted Glass Panels */
        .glass-panel {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border: 2px solid rgba(255, 255, 255, 0.6); border-radius: 20px;
            padding: 15px; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1); width: 100px;
        }

        .panel-label { font-weight: 900; font-size: 1.2rem; margin-bottom: 10px; text-transform: uppercase; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* Liquid Progress Bars */
        .bar-container {
            width: 24px; height: 150px; background: rgba(255, 255, 255, 0.5);
            border-radius: 12px; position: relative; overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        .liquid { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; transition: height 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #bar-left .liquid { background: linear-gradient(to top, #d63384, #ff6fae); }
        #bar-right .liquid { background: linear-gradient(to top, #198754, #20c997); }

        /* --- CENTER STARS --- */
        #top-center {
            position: absolute; top: 20px; width: 100%; display: flex;
            justify-content: center; gap: 20px; pointer-events: none; z-index: 21;
        }
        .star-box {
            position: relative; width: min(240px, 45vw); height: min(240px, 45vw);
            display: flex; align-items: center; justify-content: center;
            animation: float 3s ease-in-out infinite;
        }
        .star-shape { position: absolute; font-size: min(240px, 45vw); filter: drop-shadow(0 4px 10px rgba(0,0,0,0.2)); }
        .star-content { position: relative; z-index: 2; font-size: 2.5rem; font-weight: 900; color: white; text-shadow: 2px 2px 0px rgba(0,0,0,0.3); }
        .star-sub {
            position: absolute; bottom: -18px; font-size: 0.85rem; font-weight: 800;
            color: #5c3d00; background: rgba(255, 255, 255, 0.75);
            padding: 4px 10px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.9);
        }

        /* Left Star (Yellow) */
        #star-left .star-shape { color: #ffc107; -webkit-text-stroke: 6px #b8860b; }
        /* Right Star (Orange) */
        #star-right .star-shape { color: #fd7e14; -webkit-text-stroke: 6px #c2410c; }
        #star-right { display: none; }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; inset: 0; z-index: 200;
            background: url("splash.png") center center / cover no-repeat;
            background-color: #87ceeb;
            display: flex; align-items: center; justify-content: center;
        }
        #start-btn {
            padding: 20px 50px; font-size: 2rem; font-weight: 900;
            color: #5c3d00; background: #ffe44d; border: 4px solid #fff;
            border-radius: 50px; cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: pulse 1.5s infinite;
        }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }

        canvas { display: block; position: absolute; inset: 0; z-index: 5; }
        #bottom-ui {
            position: absolute; bottom: 10px; width: 100%; display: flex;
            flex-direction: column; align-items: center; gap: 10px;
        }
        #helper { text-align: center; color: #666; font-size: 0.9rem; background: rgba(255,255,255,0.8); padding: 5px 15px; border-radius: 20px; }
    </style>
</head>
<body>

    <div id="splash-screen"><button id="start-btn">PLAY!</button></div>

    <div id="hud-overlay">
        <div id="math-panel" class="neon-panel"><div>Math Score</div><div id="math-score">0</div></div>
        <div id="word-panel" class="neon-panel"><div>Word Score</div><div id="word-score">0</div></div>
    </div>

    <div id="top-center">
        <div id="star-left" class="star-box">
            <div class="star-shape">★</div>
            <div class="star-content" id="target-word">EVA</div>
            <div class="star-sub" id="word-progress"></div>
        </div>
        <div id="star-right" class="star-box">
            <div class="star-shape">★</div>
            <div class="star-content" id="target-num">25</div>
            <div class="star-sub" id="number-progress"></div>
        </div>
    </div>

    <div id="ui-layer">
        <div style="display:flex; justify-content:space-between; width:100%;">
            <div id="panel-left" class="glass-panel">
                <div class="panel-label">Letters</div>
                <div class="bar-container"><div id="bar-left" class="liquid"></div></div>
            </div>
            <div id="panel-right" class="glass-panel">
                <div class="panel-label">Numbers</div>
                <div class="bar-container"><div id="bar-right" class="liquid"></div></div>
            </div>
        </div>
        <div id="bottom-ui">
            <div id="helper">Tap screen to shoot Magic Bolts!</div>
        </div>
    </div>

    <canvas id="webgl"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // --- GAME STATE ---
        const state = {
            playing: false,
            level: 1,
            targetWord: "EVA",
            targetNum: "25",
            wordIndex: 0,
            numberSum: 0,
            numbersUnlocked: false,
            levelLetters: 0,
            levelNumbers: 0,
            projectiles: [],
            bubbles: [],
            wordList: ["IAN", "ASA", "MAMA", "POP", "ART", "CAT", "DOG"],
            numberList: ["10", "15", "20", "25", "50"]
        };

        const levelConfigs = [
            { id: 1, goal: 3, bubbleCount: 12, speedZ: 0.02, speedY: 0.002 },
            { id: 2, goal: 4, bubbleCount: 16, speedZ: 0.03, speedY: 0.004 },
            { id: 3, goal: 5, bubbleCount: 20, speedZ: 0.04, speedY: 0.006 }
        ];

        // --- AUDIO ---
        const audio = {
            bg: new Audio('loop.mp3'),
            theme: new Audio('eva_theme.mp3'),
            pop: new Audio('pop.mp3'),
            magic: new Audio('magic.mp3')
        };
        audio.bg.loop = true; audio.bg.volume = 0.4;

        // --- THREE.JS SETUP ---
        let scene, camera, renderer, busGroup;

        function init() {
            const canvas = document.querySelector('#webgl');
            renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            scene = new THREE.Scene();
            // Sky
            const skyGeo = new THREE.SphereGeometry(40, 32, 32);
            const skyMat = new THREE.MeshBasicMaterial({ color: 0xffe6f2, side: THREE.BackSide });
            scene.add(new THREE.Mesh(skyGeo, skyMat));

            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
            camera.position.set(0, 0, 10); // Backed up for shooter view

            // Lights
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
            dirLight.position.set(5, 10, 7);
            scene.add(dirLight);

            // Eva Bus
            busGroup = new THREE.Group();
            scene.add(busGroup);
            const loader = new THREE.TextureLoader();
            loader.load('eva.png', (tex) => {
                const mat = new THREE.SpriteMaterial({ map: tex });
                const sprite = new THREE.Sprite(mat);
                sprite.scale.set(3, 3, 1); // Bigger bus
                sprite.position.y = -4; // Bottom center
                busGroup.add(sprite);
            });

            // Events
            window.addEventListener('resize', onResize);
            window.addEventListener('pointerdown', onTouch); // Shooter Input
            
            document.getElementById('start-btn').addEventListener('click', startGame);
            
            animate();
        }

        // --- SPAWNING ---
        function spawnBubble(recycleBubble = null) {
            const bubble = recycleBubble || new THREE.Mesh(
                new THREE.SphereGeometry(0.6, 32, 32),
                new THREE.MeshStandardMaterial({ color: 0xffffff, transparent: true, opacity: 0.6 })
            );

            // Logic: Bias towards needed character
            let char = "E";
            if (Math.random() < 0.4) {
                char = state.targetWord[state.wordIndex];
            } else {
                const pool = "EVA123456789";
                char = pool[Math.floor(Math.random() * pool.length)];
            }

            if (bubble.userData.sprite) bubble.remove(bubble.userData.sprite);
            
            // Text Label
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.font = "bold 80px Comic Sans MS";
            ctx.fillStyle = "#6b4fc7";
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(char, 64, 64);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas) }));
            sprite.scale.set(1, 1, 1);
            bubble.add(sprite);

            // Random Position
            const x = (Math.random() - 0.5) * 10; // Wider spread
            const y = (Math.random() - 0.5) * 6;
            const z = -5 - Math.random() * 5;
            bubble.position.set(x, y, z);
            
            bubble.userData = { 
                label: char, sprite: sprite, 
                speedZ: 0.02 + Math.random() * 0.02,
                speedY: 0.002 + Math.random() * 0.005,
                wobble: Math.random() * Math.PI
            };

            if (!recycleBubble) {
                scene.add(bubble);
                state.bubbles.push(bubble);
            }
        }

        // --- SHOOTER LOGIC ---
        function onTouch(e) {
            if (!state.playing) return;
            
            // 1. Get Tap Position in World Space
            const mouse = new THREE.Vector2();
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

            const ray = new THREE.Raycaster();
            ray.setFromCamera(mouse, camera);
            const target = new THREE.Vector3();
            ray.ray.at(10, target); // Aim 10 units deep

            // 2. Create Projectile
            const bolt = new THREE.Mesh(
                new THREE.SphereGeometry(0.2, 8, 8), 
                new THREE.MeshBasicMaterial({ color: 0x00f3ff })
            );
            bolt.position.copy(busGroup.children[0].position); // Start at Bus
            
            // Calculate Velocity
            const vel = new THREE.Vector3().subVectors(target, bolt.position).normalize().multiplyScalar(0.5);
            bolt.userData = { velocity: vel, life: 60 };
            
            scene.add(bolt);
            state.projectiles.push(bolt);

            // Sound
            audio.magic.currentTime = 0;
            audio.magic.play().catch(()=>{});
        }

        // --- GAME LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            if (!state.playing) return;

            // 1. Move Bubbles
            state.bubbles.forEach(b => {
                b.position.z += b.userData.speedZ;
                b.position.y += b.userData.speedY;
                if (b.position.z > 6) spawnBubble(b);
            });

            // 2. Move Projectiles
            for (let i = state.projectiles.length - 1; i >= 0; i--) {
                const p = state.projectiles[i];
                p.position.add(p.userData.velocity);
                p.userData.life--;
                
                // Collision
                let hit = false;
                for (let j = state.bubbles.length - 1; j >= 0; j--) {
                    const b = state.bubbles[j];
                    if (p.position.distanceTo(b.position) < 0.8) {
                        handleHit(b);
                        scene.remove(p);
                        state.projectiles.splice(i, 1);
                        hit = true;
                        break;
                    }
                }
                
                if (!hit && p.userData.life <= 0) {
                    scene.remove(p);
                    state.projectiles.splice(i, 1);
                }
            }
            renderer.render(scene, camera);
        }

        function handleHit(bubble) {
            audio.pop.currentTime = 0; audio.pop.play();
            const char = bubble.userData.label;
            
            if (char === state.targetWord[state.wordIndex]) {
                state.wordIndex++;
                updateHUD();
                if (state.wordIndex >= state.targetWord.length) {
                    state.levelLetters++; // Fill Bar
                    state.wordIndex = 0; // Reset for demo
                    triggerWin();
                }
            }
            spawnBubble(bubble);
        }

        function triggerWin() {
            const h = document.getElementById('helper');
            h.innerText = "GREAT JOB!";
            h.style.color = "#d63384";
            setTimeout(()=> { h.innerText = "Tap screen to shoot Magic Bolts!"; h.style.color = "#666"; }, 2000);
            document.getElementById('bar-left').style.height = (state.levelLetters * 20) + "%";
        }

        function updateHUD() {
            const t = state.targetWord;
            const i = state.wordIndex;
            const html = `<span style="color:#ffd700">${t.substring(0,i)}</span><span style="color:#fff;text-decoration:underline">${t[i]||""}</span><span style="opacity:0.5">${t.substring(i+1)}</span>`;
            document.getElementById('target-word').innerHTML = html;
            document.getElementById('word-progress').innerText = t.substring(0, i) + "_".repeat(t.length - i);
        }

        function startGame() {
            state.playing = true;
            document.getElementById('splash-screen').style.display = 'none';
            // Init Bubbles
            for(let i=0; i<15; i++) spawnBubble();
            audio.bg.play();
            updateHUD();
        }

        function onResize() {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.onload = init;
    </script>
</body>
</html>
