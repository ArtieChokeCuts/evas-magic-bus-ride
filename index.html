<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eva's Magic Bus Ride</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; background: #f0e6ff; font-family: Arial, sans-serif; }
    #ui {
      position: absolute;
      top: 10px;
      width: 100%;
      text-align: center;
      color: #7b61ff;
      z-index: 10;
    }
    #hud {
      display: inline-flex;
      gap: 14px;
      margin-top: 8px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.75);
      border-radius: 12px;
      color: #4f3fb2;
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div id="ui">
    <h1>Super Eva's Magic Bus Ride</h1>
    <div id="hud">
      <span id="math-level">Math Level: 1</span>
      <span id="spell-level">Spelling Level: 1</span>
      <span id="targets">Targets: 11 & E</span>
    </div>
  </div>

  <script>
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const pointLight = new THREE.PointLight(0xffffff, 1, 100);
    pointLight.position.set(10, 10, 10);
    scene.add(pointLight);
    scene.add(new THREE.AmbientLight(0x404040));

    const raycaster = new THREE.Raycaster();
    const pointer = new THREE.Vector2();
    const bubbles = [];

    const state = {
      mathLevel: 1,
      spellingLevel: 1,
      mathTargets: ['11', '9', '7', '13'],
      letterTargets: ['E', 'B', 'A', 'V'],
      currentMathTarget: '11',
      currentLetterTarget: 'E'
    };

    const popSound = new Audio('pop.mp3');
    const magicSound = new Audio('magic.mp3');
    const themeSound = new Audio('eva_theme.mp3');
    themeSound.loop = true;
    themeSound.volume = 0.4;
    window.addEventListener('pointerdown', () => {
      if (themeSound.paused) {
        themeSound.play().catch(() => {});
      }
    }, { once: true });

    function drawCloud(x, y, z) {
      const cloud = new THREE.Group();
      const material = new THREE.MeshStandardMaterial({ color: 0xffffff });
      [
        [-0.6, 0, 0, 0.5],
        [0, 0.15, 0, 0.65],
        [0.65, 0, 0, 0.48]
      ].forEach(([cx, cy, cz, r]) => {
        const puff = new THREE.Mesh(new THREE.SphereGeometry(r, 24, 24), material);
        puff.position.set(cx, cy, cz);
        cloud.add(puff);
      });
      cloud.position.set(x, y, z);
      scene.add(cloud);
    }

    function createBubble(value, color, x, y, type) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 256;
      canvas.height = 256;

      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(128, 128, 120, 0, Math.PI * 2);
      ctx.fill();

      ctx.font = 'bold 120px Arial';
      ctx.fillStyle = 'white';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(value, 128, 128);

      const texture = new THREE.CanvasTexture(canvas);
      const material = new THREE.MeshPhongMaterial({ map: texture, transparent: true });
      const sphere = new THREE.Mesh(new THREE.SphereGeometry(1, 32, 32), material);
      sphere.position.set(x, y, 0);
      sphere.userData = {
        value,
        type,
        popScale: 1,
        popping: false
      };
      scene.add(sphere);
      bubbles.push(sphere);
      return sphere;
    }

    function updateHud() {
      document.getElementById('math-level').textContent = `Math Level: ${state.mathLevel}`;
      document.getElementById('spell-level').textContent = `Spelling Level: ${state.spellingLevel}`;
      document.getElementById('targets').textContent = `Targets: ${state.currentMathTarget} & ${state.currentLetterTarget}`;
    }

    function advanceTarget(type) {
      if (type === 'math') {
        state.mathLevel += 1;
        state.currentMathTarget = state.mathTargets[(state.mathLevel - 1) % state.mathTargets.length];
      } else {
        state.spellingLevel += 1;
        state.currentLetterTarget = state.letterTargets[(state.spellingLevel - 1) % state.letterTargets.length];
      }
      magicSound.currentTime = 0;
      magicSound.play().catch(() => {});
      updateHud();
    }

    function respawnBubble(mesh) {
      if (mesh.userData.type === 'math') {
        mesh.userData.value = state.currentMathTarget;
      } else {
        mesh.userData.value = state.currentLetterTarget;
      }
      const newX = mesh.userData.type === 'math' ? -2.5 - Math.random() * 2 : 2.5 + Math.random() * 2;
      const newY = 1.2 + Math.random() * 1.8;

      const newBubble = createBubble(
        mesh.userData.value,
        mesh.userData.type === 'math' ? '#7B61FF' : '#FF61B6',
        newX,
        newY,
        mesh.userData.type
      );
      newBubble.rotation.y = Math.random() * Math.PI;
    }

    function handlePointer(event) {
      pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
      pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;
      raycaster.setFromCamera(pointer, camera);

      const active = bubbles.filter((b) => !b.userData.popping);
      const intersects = raycaster.intersectObjects(active);
      if (intersects.length === 0) return;

      const hit = intersects[0].object;
      hit.userData.popping = true;

      popSound.currentTime = 0;
      popSound.play().catch(() => {});

      if (hit.userData.type === 'math' && hit.userData.value === state.currentMathTarget) {
        advanceTarget('math');
      }
      if (hit.userData.type === 'spelling' && hit.userData.value === state.currentLetterTarget) {
        advanceTarget('spelling');
      }
    }

    for (let i = 0; i < 7; i += 1) {
      drawCloud(-7 + i * 2.3, 3.8 - (i % 2) * 0.4, -4 - (i % 3));
    }

    createBubble(state.currentMathTarget, '#7B61FF', -3, 2, 'math');
    createBubble(state.currentLetterTarget, '#FF61B6', 3, 2, 'spelling');

    camera.position.z = 8;
    updateHud();

    function animate() {
      requestAnimationFrame(animate);

      for (let i = bubbles.length - 1; i >= 0; i -= 1) {
        const obj = bubbles[i];
        obj.rotation.y += 0.01;
        if (obj.userData.popping) {
          obj.userData.popScale -= 0.08;
          obj.scale.setScalar(Math.max(obj.userData.popScale, 0));
          if (obj.userData.popScale <= 0) {
            scene.remove(obj);
            bubbles.splice(i, 1);
            respawnBubble(obj);
          }
        }
      }

      renderer.render(scene, camera);
    }

    window.addEventListener('pointerdown', handlePointer);
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    animate();
  </script>
</body>
</html>
