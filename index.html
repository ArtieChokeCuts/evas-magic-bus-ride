<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Super Eva's Magic Bus Ride</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <style>
    /* --- CORE VISUALS --- */
    * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; }
    body { 
        overflow: hidden; 
        background: linear-gradient(to bottom, #f0f8ff 0%, #fffafa 100%); 
        font-family: 'Comic Sans MS', Arial, sans-serif; 
        touch-action: none; 
    }

    /* --- UI --- */
    #splash-screen {
        position: fixed; inset: 0; z-index: 100;
        background: #f0f8ff;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    h1 { color: #ff00ff; font-size: 3rem; margin-bottom: 20px; text-align: center; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
    #start-btn {
        padding: 20px 60px; font-size: 2rem; font-weight: 900; border-radius: 50px;
        border: none; background: #ffc107; color: white; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    
    #ui {
      position: absolute; top: 10px; width: 100%; text-align: center; z-index: 10; display: none;
    }
    #hud {
      display: inline-flex; gap: 14px; margin-top: 8px; padding: 8px 12px;
      background: rgba(255, 255, 255, 0.85); border-radius: 12px; color: #4f3fb2; font-weight: 700;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 1.2rem;
    }
    canvas { display: block; position: absolute; inset: 0; z-index: 5; }
  </style>
</head>
<body>
  <div id="splash-screen">
      <h1>Super Eva's Magic Ride</h1>
      <button id="start-btn">PLAY!</button>
  </div>
  
  <div id="ui">
    <div id="hud">
      <span id="math-level">Math Level: 1</span>
      <span id="spell-level">Spelling Level: 1</span>
      <span id="targets">Targets: 11 & E</span>
    </div>
  </div>

  <script>
    // --- AUDIO SETUP ---
    const audio = {
        loop: new Audio('loop.mp3'),
        pop: new Audio('pop.mp3'),
        magic: new Audio('magic.mp3'),
        evaTheme: new Audio('eva_theme.mp3')
    };
    audio.loop.loop = true;

    // --- GAME LOGIC STATE ---
    const state = {
      playing: false,
      mathLevel: 1, spellingLevel: 1,
      mathTargets: ['11', '9', '7', '13'],
      letterTargets: ['E', 'V', 'A', 'B'],
      currentMathTarget: '11',
      currentLetterTarget: 'E'
    };

    // --- ENGINE SETUP ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 8;
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const pointLight = new THREE.PointLight(0xffffff, 1, 100);
    pointLight.position.set(10, 10, 10);
    scene.add(pointLight);
    scene.add(new THREE.AmbientLight(0xffffff, 0.8));

    const raycaster = new THREE.Raycaster();
    const pointer = new THREE.Vector2();
    const bubbles = [];
    const clouds = [];
    let evaSprite;

    // --- LOAD EVA SOUL ---
    new THREE.TextureLoader().load('eva.png', (tex) => {
        const mat = new THREE.SpriteMaterial({ map: tex });
        evaSprite = new THREE.Sprite(mat);
        evaSprite.scale.set(5, 5, 1);
        evaSprite.position.set(0, -2, 0); 
        scene.add(evaSprite);
    });

    // --- LOAD CLOUDS SOUL ---
    function createMovingClouds() {
        const cvs = document.createElement('canvas'); cvs.width = 128; cvs.height = 64;
        const c = cvs.getContext('2d');
        c.fillStyle = "white";
        c.beginPath(); c.arc(64,32,30,0,Math.PI*2); c.fill();
        c.beginPath(); c.arc(40,32,20,0,Math.PI*2); c.fill();
        c.beginPath(); c.arc(88,32,20,0,Math.PI*2); c.fill();
        const tex = new THREE.CanvasTexture(cvs);

        for(let i=0; i<12; i++) {
            const s = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex, transparent: true, opacity: 0.9 }));
            s.scale.set(6, 3, 1);
            s.position.set((Math.random()-0.5)*20, Math.random()*6, (Math.random()-0.5)*10 - 2);
            s.userData = { speed: 0.005 + Math.random()*0.01 };
            clouds.push(s); scene.add(s);
        }
    }
    createMovingClouds();

    // --- BUBBLE & HUD BRAINS ---
    function createBubble(value, color, x, y, type) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 256; canvas.height = 256;

      ctx.fillStyle = color;
      ctx.beginPath(); ctx.arc(128, 128, 120, 0, Math.PI * 2); ctx.fill();

      ctx.font = 'bold 120px Arial'; ctx.fillStyle = 'white';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText(value, 128, 128);

      const texture = new THREE.CanvasTexture(canvas);
      const material = new THREE.MeshPhongMaterial({ map: texture, transparent: true, opacity: 0.9 });
      const sphere = new THREE.Mesh(new THREE.SphereGeometry(1, 32, 32), material);
      sphere.position.set(x, y, 0);
      
      // Speed logic: Float up slowly
      sphere.userData = { value, type, popScale: 1, popping: false, speed: 0.02 + Math.random()*0.02 };
      
      scene.add(sphere);
      bubbles.push(sphere);
      return sphere;
    }

    function updateHud() {
      document.getElementById('math-level').textContent = `Math Level: ${state.mathLevel}`;
      document.getElementById('spell-level').textContent = `Spelling Level: ${state.spellingLevel}`;
      document.getElementById('targets').textContent = `Targets: ${state.currentMathTarget} & ${state.currentLetterTarget}`;
    }

    function advanceTarget(type) {
      if (type === 'math') {
        state.mathLevel += 1;
        state.currentMathTarget = state.mathTargets[(state.mathLevel - 1) % state.mathTargets.length];
      } else {
        state.spellingLevel += 1;
        state.currentLetterTarget = state.letterTargets[(state.spellingLevel - 1) % state.letterTargets.length];
        
        // Easter Egg: If they hit 'A' finishing E-V-A, trigger the theme song
        if (state.currentLetterTarget === 'B') {
            audio.evaTheme.currentTime = 0;
            audio.evaTheme.play().catch(()=>{});
        }
      }
      audio.magic.currentTime = 0; audio.magic.play().catch(()=>{});
      updateHud();
    }

    function respawnBubble(mesh) {
      if (mesh.userData.type === 'math') mesh.userData.value = state.currentMathTarget;
      else mesh.userData.value = state.currentLetterTarget;
      
      // Spawn at the bottom so it floats up
      const newX = mesh.userData.type === 'math' ? -2.5 - Math.random() * 2 : 2.5 + Math.random() * 2;
      const newY = -6; 

      const newBubble = createBubble(
        mesh.userData.value,
        mesh.userData.type === 'math' ? '#7B61FF' : '#FF61B6',
        newX, newY, mesh.userData.type
      );
      newBubble.rotation.y = Math.random() * Math.PI;
    }

    function handlePointer(event) {
      if (!state.playing) return;
      pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
      pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;
      raycaster.setFromCamera(pointer, camera);

      const active = bubbles.filter((b) => !b.userData.popping);
      const intersects = raycaster.intersectObjects(active);
      if (intersects.length === 0) return;

      const hit = intersects[0].object;
      hit.userData.popping = true;

      audio.pop.currentTime = 0; audio.pop.play().catch(()=>{});

      if (hit.userData.type === 'math' && hit.userData.value === state.currentMathTarget) advanceTarget('math');
      if (hit.userData.type === 'spelling' && hit.userData.value === state.currentLetterTarget) advanceTarget('spelling');
    }

    // --- INITIALIZE ---
    createBubble(state.currentMathTarget, '#7B61FF', -3, -2, 'math');
    createBubble(state.currentLetterTarget, '#FF61B6', 3, -4, 'spelling');
    updateHud();

    function startGame() {
        document.getElementById('splash-screen').style.display = 'none';
        document.getElementById('ui').style.display = 'block';
        state.playing = true;
        audio.loop.play().catch(()=>{});
    }

    document.getElementById('start-btn').addEventListener('click', startGame);
    window.addEventListener('pointerdown', handlePointer);
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // --- ANIMATION ENGINE ---
    function animate() {
      requestAnimationFrame(animate);
      
      if (state.playing) {
          // Move clouds
          clouds.forEach(c => { 
              c.position.x += c.userData.speed; 
              if(c.position.x > 10) c.position.x = -10; 
          });
          
          // Bob Eva
          if (evaSprite) evaSprite.position.y = -2 + Math.sin(Date.now()*0.002)*0.1;

          // Float and pop bubbles
          for (let i = bubbles.length - 1; i >= 0; i -= 1) {
            const obj = bubbles[i];
            obj.rotation.y += 0.01;
            
            if (!obj.userData.popping) {
                obj.position.y += obj.userData.speed;
                // If it floats off screen, recycle it
                if (obj.position.y > 6) {
                    scene.remove(obj);
                    bubbles.splice(i, 1);
                    respawnBubble(obj);
                }
            } else {
              obj.userData.popScale -= 0.08;
              obj.scale.setScalar(Math.max(obj.userData.popScale, 0));
              if (obj.userData.popScale <= 0) {
                scene.remove(obj);
                bubbles.splice(i, 1);
                respawnBubble(obj);
              }
            }
          }
      }
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
